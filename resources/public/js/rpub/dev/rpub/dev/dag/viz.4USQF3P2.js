import{jsx as v,jsxs as H}from"react/jsx-runtime";import*as l from"cherry-cljs/cljs.core.js";import{Controls as V,MiniMap as D,ReactFlow as J,addEdge as P,useNodesState as W,useEdgesState as X,Handle as Q,Position as M}from"@xyflow/react";import{useEffect as Y,useState as k,useCallback as Z}from"react";import*as j from"cherry-cljs/lib/clojure.string.js";import*as $ from"rpub.admin.impl";import*as S from"rpub.lib.dag";import*as ll from"rpub.lib.html";import*as x from"rpub.lib.http";var R=function(a){const e=a,t=l.__destructure_map.call(null,e).data;return H("div",{style:"width: 400px; border: 1px solid #ccc; padding: 1rem; border-radius: 6px; background: #fff",children:[v(Q,{type:"source",position:M.Left}),t.label,v(Q,{type:"target",position:M.Right})]})},nl=function(a){return l.map_indexed.call(null,function(e,n){const t=n,o=l.nth.call(null,t,0,null),c=l.nth.call(null,t,1,null);return l.array_map(l.keyword("id"),l.pr_str.call(null,o),l.keyword("type"),"custom-node",l.keyword("position"),l.array_map(l.keyword("x"),0,l.keyword("y"),e*100),l.keyword("data"),l.array_map(l.keyword("label"),l.str.call(null,o)))},S.nodes.call(null,a))},al=function(a){return l.map.call(null,function(e){const n=e,t=l.nth.call(null,n,0,null),o=l.nth.call(null,n,1,null),c=n;return l.array_map(l.keyword("id"),l.str.call(null,c),l.keyword("source"),l.pr_str.call(null,t),l.keyword("target"),l.pr_str.call(null,o))},S.edges.call(null,a))},A=l.array_map(l.keyword("custom-node"),R),N=l.array_map(),O=100,C=function(a,e){return x.post.call(null,"/admin/api/get-dag-metadata",l.array_map(l.keyword("format"),l.keyword("transit"),l.keyword("body"),l.array_map(l.keyword("storage-id"),a),l.keyword("on-complete"),e))},G=ll.debounce.call(null,function(a,e){const n=e,t=l.__destructure_map.call(null,n),o=l.get.call(null,t,l.keyword("nodes")),c=l.map.call(null,function(r){return l.select_keys.call(null,r,l.vector(l.keyword("id"),l.keyword("position")))},l.js__GT_clj.call(null,o,l.keyword("keywordize-keys"),!0)),p=$.__GT_unsaved_changes.call(null,a,l.array_map(l.keyword("saved-nodes"),c)),_=l.array_map(l.keyword("format"),l.keyword("transit"),l.keyword("body"),p,l.keyword("on-complete"),function(r,i){if(l.truth_.call(null,i))return console.log(i)});return x.post.call(null,"/admin/api/update-dag-metadata",_)},O),I=function(a,e){return l.into.call(null,l.array_map(),l.map.call(null,function(n){return l.vector(a.call(null,n),n)},e))},K=function(a,e){const n=a.data.label,t=l.reduce.call(null,function(c,p){const _=p,r=l.nth.call(null,_,0,null),i=l.nth.call(null,_,1,null);return l.truth_.call(null,j.starts_with_QMARK_.call(null,c,r))?l.reduced.call(null,l.str.call(null,i,l.subs.call(null,c,l.count.call(null,r)))):c},n,e),o=Object.assign({},a.data,{label:t});return Object.assign({},a,{data:o})},U=function(a){const e=a,n=l.__destructure_map.call(null,e),t=l.get.call(null,n,l.keyword("aliases")),o=l.get.call(null,n,l.keyword("storage-id")),c=l.get.call(null,n,l.keyword("initial-nodes")),p=l.get.call(null,n,l.keyword("dag-metadata")),_=l.get.call(null,n,l.keyword("initial-edges")),r=l.get.call(null,n,l.keyword("visible")),i=I.call(null,l.keyword("id"),l.keyword("saved-nodes").call(null,p)),b=l.map.call(null,function(s){return l.merge.call(null,s,l.get.call(null,i,l.keyword("id").call(null,s)))},c),m=k.call(null,!1),g=l.nth.call(null,m,0,null),w=l.nth.call(null,m,1,null),u=W.call(null,l.clj__GT_js.call(null,b)),h=l.nth.call(null,u,0,null),E=l.nth.call(null,u,1,null),y=l.nth.call(null,u,2,null),d=X.call(null,l.clj__GT_js.call(null,_)),T=l.nth.call(null,d,0,null),L=l.nth.call(null,d,1,null),z=l.nth.call(null,d,2,null),B=Z.call(null,function(s){return L.call(null,function(f){return P.call(null,s,f)})},[L]),F=function(s){const f=y.call(null,s);return l.truth_.call(null,g)?G.call(null,o,l.array_map(l.keyword("nodes"),h,l.keyword("edges"),T)):w.call(null,!0),f},q=function(s){const f=z.call(null,s);return l.truth_.call(null,g)?G.call(null,o,l.array_map(l.keyword("nodes"),h,l.keyword("edges"),T)):w.call(null,!0),f};return l.vector(l.keyword("div.absolute.inset-0.bg-white.z-50"),l.array_map(l.keyword("class"),l.truth_.call(null,r)?null:"hidden"),H(J,{nodes:h.map(function(s){return K.call(null,s,t)}),nodeTypes:l.clj__GT_js.call(null,A),onNodesChange:F,edges:T,edgeTypes:l.clj__GT_js.call(null,N),onEdgesChange:q,onConnect:B,fitView:!0,children:[v(D,{}),v(V,{})]}))},el=function(a){const e=a,n=l.__destructure_map.call(null,e),t=n,o=l.get.call(null,n,l.keyword("storage-id")),c=k.call(null,!1),p=l.nth.call(null,c,0,null),_=l.nth.call(null,c,1,null),r=k.call(null,!1),i=l.nth.call(null,r,0,null),b=l.nth.call(null,r,1,null),m=k.call(null,null),g=l.nth.call(null,m,0,null),w=l.nth.call(null,m,1,null);if(Y.call(null,function(){const u=function(){return _.call(null,!0),b.call(null,l.not)},h=function(y){const d=y.ctrlKey;return l.truth_.call(null,d)?l._EQ_.call(null,y.key,"o"):d},E=function(y){if(l.truth_.call(null,h.call(null,y)))return l.truth_.call(null,j.includes_QMARK_.call(null,location.hash,"dag"))?location.hash="":location.hash="dag"};return window.addEventListener("hashchange",u),window.addEventListener("keydown",E),l.truth_.call(null,j.includes_QMARK_.call(null,location.hash,"dag"))&&u.call(null),C.call(null,o,function(y,d){return l.truth_.call(null,d)?console.error(d):w.call(null,y)}),function(){return window.removeEventListener("keydown",E),window.removeEventListener("hashchange",u)}},[]),l.truth_.call(null,(()=>{const u=p;return l.truth_.call(null,u)?l.seq.call(null,g):u})()))return l.vector(U,l.merge.call(null,t,l.array_map(l.keyword("visible"),i,l.keyword("dag-metadata"),g)))};export{R as custom_node,N as edge_types,C as get_dag_metadata,I as index_by,al as initial_edges,nl as initial_nodes,A as node_types,el as overlay,U as overlay_STAR_,O as save_debounce_ms,G as update_dag_metadata_BANG_,K as view_node};
