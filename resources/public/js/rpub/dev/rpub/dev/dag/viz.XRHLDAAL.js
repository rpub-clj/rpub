import{jsx as v,jsxs as H}from"react/jsx-runtime";import*as l from"cherry-cljs/cljs.core.js";import{Controls as V,MiniMap as D,ReactFlow as J,addEdge as P,useNodesState as W,useEdgesState as X,Handle as Q,Position as M}from"@xyflow/react";import{useCallback as Y,useEffect as Z,useState as k}from"react";import*as j from"cherry-cljs/lib/clojure.string.js";import*as S from"rpub.lib.dag";import*as $ from"rpub.lib.html";import*as x from"rpub.lib.http";import*as ll from"rpub.plugins.admin.impl";var R=function(t){const a=t,e=l.__destructure_map.call(null,a).data;return H("div",{style:"width: 400px; border: 1px solid #ccc; padding: 1rem; border-radius: 6px; background: #fff",children:[v(Q,{type:"source",position:M.Left}),e.label,v(Q,{type:"target",position:M.Right})]})},nl=function(t){return l.map_indexed.call(null,function(a,n){const e=n,o=l.nth.call(null,e,0,null),c=l.nth.call(null,e,1,null);return l.array_map(l.keyword("id"),l.pr_str.call(null,o),l.keyword("type"),"custom-node",l.keyword("position"),l.array_map(l.keyword("x"),0,l.keyword("y"),a*100),l.keyword("data"),l.array_map(l.keyword("label"),l.str.call(null,o)))},S.nodes.call(null,t))},tl=function(t){return l.map.call(null,function(a){const n=a,e=l.nth.call(null,n,0,null),o=l.nth.call(null,n,1,null),c=n;return l.array_map(l.keyword("id"),l.str.call(null,c),l.keyword("source"),l.pr_str.call(null,e),l.keyword("target"),l.pr_str.call(null,o))},S.edges.call(null,t))},A=l.array_map(l.keyword("custom-node"),R),N=l.array_map(),O=100,C=function(t,a){return x.post.call(null,"/admin/api/get-dag-metadata",l.array_map(l.keyword("format"),l.keyword("transit"),l.keyword("body"),l.array_map(l.keyword("storage-id"),t),l.keyword("on-complete"),a))},G=$.debounce.call(null,function(t,a){const n=a,e=l.__destructure_map.call(null,n),o=l.get.call(null,e,l.keyword("nodes")),c=l.map.call(null,function(r){return l.select_keys.call(null,r,l.vector(l.keyword("id"),l.keyword("position")))},l.js__GT_clj.call(null,o,l.keyword("keywordize-keys"),!0)),p=ll.__GT_unsaved_changes.call(null,t,l.array_map(l.keyword("saved-nodes"),c)),_=l.array_map(l.keyword("format"),l.keyword("transit"),l.keyword("body"),p,l.keyword("on-complete"),function(r,i){if(l.truth_.call(null,i))return console.log(i)});return x.post.call(null,"/admin/api/update-dag-metadata",_)},O),K=function(t,a){return l.into.call(null,l.array_map(),l.map.call(null,function(n){return l.vector(t.call(null,n),n)},a))},I=function(t,a){const n=t.data.label,e=l.reduce.call(null,function(c,p){const _=p,r=l.nth.call(null,_,0,null),i=l.nth.call(null,_,1,null);return l.truth_.call(null,j.starts_with_QMARK_.call(null,c,r))?l.reduced.call(null,l.str.call(null,i,l.subs.call(null,c,l.count.call(null,r)))):c},n,a),o=Object.assign({},t.data,{label:e});return Object.assign({},t,{data:o})},U=function(t){const a=t,n=l.__destructure_map.call(null,a),e=l.get.call(null,n,l.keyword("aliases")),o=l.get.call(null,n,l.keyword("storage-id")),c=l.get.call(null,n,l.keyword("initial-nodes")),p=l.get.call(null,n,l.keyword("dag-metadata")),_=l.get.call(null,n,l.keyword("initial-edges")),r=l.get.call(null,n,l.keyword("visible")),i=K.call(null,l.keyword("id"),l.keyword("saved-nodes").call(null,p)),b=l.map.call(null,function(s){return l.merge.call(null,s,l.get.call(null,i,l.keyword("id").call(null,s)))},c),m=k.call(null,!1),h=l.nth.call(null,m,0,null),w=l.nth.call(null,m,1,null),u=W.call(null,l.clj__GT_js.call(null,b)),g=l.nth.call(null,u,0,null),E=l.nth.call(null,u,1,null),y=l.nth.call(null,u,2,null),d=X.call(null,l.clj__GT_js.call(null,_)),T=l.nth.call(null,d,0,null),L=l.nth.call(null,d,1,null),z=l.nth.call(null,d,2,null),F=Y.call(null,function(s){return L.call(null,function(f){return P.call(null,s,f)})},[L]),q=function(s){const f=y.call(null,s);return l.truth_.call(null,h)?G.call(null,o,l.array_map(l.keyword("nodes"),g,l.keyword("edges"),T)):w.call(null,!0),f},B=function(s){const f=z.call(null,s);return l.truth_.call(null,h)?G.call(null,o,l.array_map(l.keyword("nodes"),g,l.keyword("edges"),T)):w.call(null,!0),f};return l.vector(l.keyword("div.absolute.inset-0.bg-white.z-50"),l.array_map(l.keyword("class"),l.truth_.call(null,r)?null:"hidden"),H(J,{nodes:g.map(function(s){return I.call(null,s,e)}),nodeTypes:l.clj__GT_js.call(null,A),onNodesChange:q,edges:T,edgeTypes:l.clj__GT_js.call(null,N),onEdgesChange:B,onConnect:F,fitView:!0,children:[v(D,{}),v(V,{})]}))},al=function(t){const a=t,n=l.__destructure_map.call(null,a),e=n,o=l.get.call(null,n,l.keyword("storage-id")),c=k.call(null,!1),p=l.nth.call(null,c,0,null),_=l.nth.call(null,c,1,null),r=k.call(null,!1),i=l.nth.call(null,r,0,null),b=l.nth.call(null,r,1,null),m=k.call(null,null),h=l.nth.call(null,m,0,null),w=l.nth.call(null,m,1,null);if(Z.call(null,function(){const u=function(){return _.call(null,!0),b.call(null,l.not)},g=function(y){const d=y.ctrlKey;return l.truth_.call(null,d)?l._EQ_.call(null,y.key,"o"):d},E=function(y){if(l.truth_.call(null,g.call(null,y)))return l.truth_.call(null,j.includes_QMARK_.call(null,location.hash,"dag"))?location.hash="":location.hash="dag"};return window.addEventListener("hashchange",u),window.addEventListener("keydown",E),l.truth_.call(null,j.includes_QMARK_.call(null,location.hash,"dag"))&&u.call(null),C.call(null,o,function(y,d){return l.truth_.call(null,d)?console.error(d):w.call(null,y)}),function(){return window.removeEventListener("keydown",E),window.removeEventListener("hashchange",u)}},[]),l.truth_.call(null,(()=>{const u=p;return l.truth_.call(null,u)?l.seq.call(null,h):u})()))return l.vector(U,l.merge.call(null,e,l.array_map(l.keyword("visible"),i,l.keyword("dag-metadata"),h)))};export{R as custom_node,N as edge_types,C as get_dag_metadata,K as index_by,tl as initial_edges,nl as initial_nodes,A as node_types,al as overlay,U as overlay_STAR_,O as save_debounce_ms,G as update_dag_metadata_BANG_,I as view_node};
